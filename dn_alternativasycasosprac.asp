<%'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++'muestra buscador y resultados para alternativas y casos practicos (para estos ultimos, se pasa el parametro cp=1)'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++%><!--#include file="adovbs.inc"--><!--#include file="dn_conexion.asp"--><!--#include file="dn_funciones_comunes.asp"--><!--#include file="dn_funciones_texto.asp"--><!--#include file="dn_restringida.asp"--><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html lang="es" xmlns="http://www.w3.org/1999/xhtml"><head><title>ISTAS: risctox</title><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" /><meta name="Title" content="ECOinformas" /><meta name="Author" content="XiP multimèdia" /><meta name="description" content="Información, formación y asesoramiento sobre medio ambiente para trabajadores de PYME" /><meta name="Subject" content="Información, formación y asesoramiento sobre medio ambiente para trabajadores de PYME" /><meta name="Keywords" content="Información, formación y asesoramiento sobre medio ambiente para trabajadores de PYME" /><meta name="Language" content="Spanish" /><meta name="Revisit" content="15 days" /><meta name="Distribution" content="Global" /><meta name="Robots" content="All" /><link rel="stylesheet" type="text/css" href="estructura.css"><link rel="stylesheet" type="text/css" href="dn_estilos.css"><script type="text/javascript">function cambiapag(paginadest){	var frm = document.forms["myform"]; 	frm.busc.value=2;	frm.pag.value=paginadest;	frm.submit();}function primerapag(){	var frm = document.forms["myform"]; 	frm.busc.value=1;	frm.pag.value=1;	frm.submit();}</script></head><body><div id="contenedor">	<div id="sombra_arriba"></div>  	<div id="sombra_lateral">		<div id="caja">		  <!--#include file="dn_cabecera.asp"-->		<div id="texto">			<div class="texto"><!-- ################ CONTENIDO ###################### --><%'valores por defectonregs=20'recogemos valores del formulariopag=request("pag")texto=request.form("texto")tema=request.form("tema")cp=request.QueryString("cp")pag = EliminaInyeccionSQL(pag)texto = EliminaInyeccionSQL(texto)tema = EliminaInyeccionSQL(tema)cp = EliminaInyeccionSQL(cp)if cp="" then cp=0if cp=1 then	mititulo="Casos Prácticos"else	mititulo="Alternativas"end if%><table width="100%" border="0"><tr><td><p class=campo>Est&aacute;s en: <a href=index.asp?idpagina=550>Plataforma prevención de riesgo químico</a>&nbsp;&gt;&nbsp;<a href="dn_alternativas_portada.asp">BBDD Alternativas</a> &gt; <%=mititulo%> </p></td><td><input type="button" name="volver" class="boton2" value="Volver a la portada de Alternativas" onclick="window.location='dn_alternativas_portada.asp';"></td></tr></table><p class=titulo3>Buscador de <%=mititulo%></p><div align="center"><form class="texto" action="dn_alternativasycasosprac.asp?cp=<%=cp%>" method="post"><fieldset><legend><strong>Texto</strong></legend><p class="texto">Introduzca el texto a buscar, o deje el campo en blanco si prefiere que se muestren todos los resultados:</p><input type="hidden" name="busc" value="1" /><input name="texto" type="text" value="<%=texto%>" size="40" /><input type="submit" value="Buscar" class="boton2" /></fieldset></form><br /><%if cp=0 then%><form class="texto" action="dn_alternativasycasosprac.asp?busc=1&cp=<%=cp%>" method="post"><fieldset><legend><strong>Tema</strong></legend><p class="texto">O bien seleccione un tema:</p><select name="tema" class="campo"><option>SELECCIONE UN TEMA</option><%sqll="SELECT DISTINCT tema  FROM dn_alter_ficheros order by tema"Set rstt=objConnection2.Execute(sqll)if not  rstt.eof then	do while not rstt.eof		if tema<>"" then			if tema<>rstt("tema") then				marcado=""			else				marcado="selected"			end if		end if		response.write "<option value='" &rstt("tema")& "'" &marcado&">" &corta (rstt("tema"), 95, "puntossuspensivos")& "</option>" 	rstt.movenext	loopend ifrstt.CloseSet rstt = Nothing%></select><input type="hidden" name="busc" value="1" /><input type="submit" value="Buscar" class="boton2" /></fieldset></form><%end if%><%'vemos si tenemos que mostrar resultadosbusc=request.form("busc")busc = EliminaInyeccionSQL(busc)'para cp=1 mostramos resultados ya la primera vez que entramosif cp=1 and busc="" then	busc=1end ifif busc<>""   then	if request("tema")="SELECCIONE UN TEMA" then%>		<fieldset id="flashmsg" style="width:60%; margin:50px; "><legend class="advertencia"><strong>Advertencia</strong></legend>Debe seleccionar un tema. Si lo que desea es que se muestren todos los registros, deje en blanco el campo <strong>Texto</strong> y pulse el botón <strong>Buscar</strong> que se encuentra a su derecha.</fieldset><%	else		select case busc						case 1: 'han dado a buscar													if cp=1 then							 condicion=condicion& " tema like '%Casos práctico%' AND"						else							if tema<>"" then condicion=condicion& " tema like '" &tema& "' AND"						end if																			if texto<>"" then							condicion = condicion & "("							cualquier=replace(texto,"  "," ")									' Dividimos la cadena en palabras separadas por espacios							arraycualquier = split(cualquier, " ")												' Montamos la condicion de texto (reemplazando caracteres)								FOR i=0 to UBound(arraycualquier)										mitermino=arraycualquier(i)										mitermino=quitartildes(mitermino)								mitermino=montartildes(mitermino)								condicion = condicion & " (titulo LIKE '%" &mitermino& "%') or (resumen LIKE '%" &mitermino& "%') or (tema LIKE '%" &mitermino& "%')  OR"							NEXT																if condicion<>"" then condicion= left(condicion,len(condicion)-3) & ") AND"						end if												if condicion<>"" then condicion=" WHERE "  &left(condicion,len(condicion)-3) 'quitamos el último or/and											'COMPLICACION: lo primero que tenemos que hacer es un select distinc exclusivamente de titulos, ya que puede haber registros con el mismo titulo, pero distinto tema/id				sqls="select distinct titulo, id from dn_alter_ficheros " &condicion				'response.write sqls									Set objRst = Server.CreateObject("ADODB.Recordset")					objRst.Open sqls, objConnection2, adOpenStatic, adCmdText														IF not objRst.eof THEN 											'hacemos lista de ids						mititulo=""						do while not objRst.eof							if mititulo<>objRst("titulo") then								arr=arr& objRst("id")& ","								mititulo=objRst("titulo")								hr=hr+1							 end if						objRst.movenext						loop												'esta sera la pagina 1						pag = 1												END IF												objRst.Close					Set objRst=Nothing					case 2: 'paginando								hr=request("hr")				pag=request("pag")				arr=request("arr")										hr = EliminaInyeccionSQL(hr)				pag = EliminaInyeccionSQL(pag)				arr = EliminaInyeccionSQL(arr)					end select 'cual busc						'RESULTADOS DE BUSQUEDA (para busc 1 y busc 2)			'seleccionamos datos a mostrar de los x registros que toquen			if hr=0 then	%>				<fieldset id="flashmsg" style="width:60%; margin:50px; "><legend class="advertencia"><strong>Advertencia</strong></legend>No se encontraron registros que coincidan con su consulta.</fieldset>	<%			else				arrayx = split(arr, ",")								FOR i=0 to UBound(arrayx)-1		 'OJO, luego hay que hacer que muestre solo las de paginacion					cadenaids=cadenaids  &arrayx(i)&","						NEXT									'quitamos la ultima coma				cadenaids= left(cadenaids,len(cadenaids)-1)				sqlpag="select id, tema, titulo from dn_alter_ficheros as sus WHERE id IN(" &cadenaids& ") ORDER BY tema, titulo" 				'response.write "<p>" &sqlpag				set rstpag=objConnection2.execute(sqlpag)				if not rstpag.eof then									arrayDatos = rstpag.GetRows								registroini=(pag*nregs)-nregs					registrofin=registroini+nregs										if registrofin>=hr-1 then						registrofin=hr					end if										registrofin=registrofin-1							' Generamos tabla de resultados, comprobando que no se repiten los títulos					for contadorFilas=registroini to registrofin												  tablares=tablares & "<tr>" 								  'tablares=tablares & "<td>" & contadorFilas+1 & "</td>"								  'tablares=tablares & "<td class='celda_risctox'>" &corta(arrayDatos(1,contadorFilas),1000, "puntossuspensivos")& "</td>"								  tablares=tablares & "<td class='celda_risctox' align='left'><a href='dn_alternativas_ficha_fichero.asp?id_fichero=" &arrayDatos(0,contadorFilas)& "'>" &corta(arrayDatos(2,contadorFilas),1000, "puntossuspensivos")& "</a></td>"															  tablares=tablares & "</tr>" 					next									end if				rstpag.close				set rstpag=nothing								'iniciotabla="<table class='tabla3' width='90%' align='center' border='0' cellpadding='4' cellspacing='0'> <tr><td class='subtitulo3'>	<table width='100%' align='center'><tr><td>"				'if cp<>1 then 'alternativas					'iniciotabla=iniciotabla& "Alternativas &nbsp;</td><td align=right><!-- <img src='imagenes/ico_alt_procesos.gif'> -->"				'else					'iniciotabla=iniciotabla& "Casos prácticos &nbsp;</td><td align=right><!-- <img src='imagenes/ico_alt_procesos.gif'> -->"				'end if				'iniciotabla=iniciotabla& "</td></tr></table></td> </tr>"						response.Write("<p align='left' class='neg' style='margin:15px 0; padding:10px;'>Se han encontrado " &hr& " registros. Se muestran registros del " &registroini+1& " al " &registrofin+1& ":</p>")				'response.write "<br />"				tablares="<table class='tabla3' width='90%' align='center' border='0' cellpadding='4' cellspacing='0'><tr><th>Título</th></tr>" &tablares& "</table>"				response.write tablares								if hr>nregs then%>						<form name="myform" method="post" action="dn_alternativasycasosprac.asp?cp=<%=cp%>">				<input type="hidden" name="texto" value="<%=texto%>" />				<input type="hidden" name="tema" value="<%=tema%>" />				<input type="hidden" name="pag" value="<%=pag%>" />				<input type="hidden" name="arr" value="<%=arr%>" />				<input type="hidden" name="hr" value="<%=hr%>" />				<input type="hidden" name="busc" value="2" />				<div align='center' style="margin:20px 10px; background-color: #3399CC; padding:3px;"><%paginacion%></div>				</form><%				end if			end if		end ifend if 'busc%></div><!-- ############ FIN DE CONTENIDO ################## --><br>Esta página ha sido desarrollada por <a href="http://www.istas.ccoo.es/" target="_blank"><b>ISTAS</b></a> que es una Fundación de <a href="http://www.ccoo.es/" target="_blank"><font color="#FF0000"><b>CC.OO.</b></font></a><br>						  </div>				<p>&nbsp;</p>		  </div>									<map name="Map1" id="Map1">            		<area shape="rect" coords="307,38,399,104" href="http://www.fundacion-biodiversidad.es" target="_blank" alt="Fundación Biodiversidad" />            		<area shape="rect" coords="400,38,546,104" href="http://www.istas.ccoo.es" target="_blank" alt="Instituto Sindical de Trabajo, Ambiente y Salud" />      			<area shape="rect" coords="547,38,701,104" href="http://www.mtas.es/UAFSE/default.htm" target="_blank" alt="Fondo Social Europeo" />		  </map>			<map name="Map2" id="Map2">            		<area shape="rect" coords="300,8,392,66" href="http://www.fundacion-biodiversidad.es" target="_blank" alt="Fundación Biodiversidad" />            		<area shape="rect" coords="393,8,539,66" href="http://www.istas.ccoo.es" target="_blank" alt="Instituto Sindical de Trabajo, Ambiente y Salud" />      			<area shape="rect" coords="540,8,694,66" href="http://www.mtas.es/UAFSE/default.htm" target="_blank" alt="Fondo Social Europeo" />		  </map>      			<map name="Map3" id="Map3">            		<area shape="rect" coords="300,18,392,80" href="http://www.fundacion-biodiversidad.es" target="_blank" alt="Fundación Biodiversidad" />            		<area shape="rect" coords="393,18,539,80" href="http://www.istas.ccoo.es" target="_blank" alt="Instituto Sindical de Trabajo, Ambiente y Salud" />      			<area shape="rect" coords="540,18,694,80" href="http://www.mtas.es/UAFSE/default.htm" target="_blank" alt="Fondo Social Europeo" />      			</map>			<img src="imagenes/pie3.jpg" width="708" border="0" usemap="#Map3">      			    				  </div>  </div>	<div id="sombra_abajo"></div></div></body></html><%cerrarconexion%>